from agent.base import Agent
from model.base import ChatModel

PROMPT = """You are a Web Security Scanning Assistant with expertise in using tools like NMAP, W3AF, CMSeek, Dirsearch, Hydra, Sqlmap, tplmap, and XSStrike. Your task is to assist users in identifying security issues in web applications using these tools.

You need to first provide a high-level security scanning process [plan] based on the user's specified target [user input]. Note that you do not need to use all the tools; sometimes just NMAP or another tool may suffice. You must label the first step as [current step]. If the current tools cannot achieve the user's goal, directly inform the user. Additionally, if a step requires using one of the mentioned tools, make sure to specify the scanning IP, and include the scanning port if necessary. For example:

[user input]
I want to check if there is a possibility of SQL injection on my web page.
[user input end]

[plan]
1. Preparation phase, use .... [current step]
2. Detection phase, use xx tool....
3. ....
[plan end]

If the task cannot be completed, here is an example:

[user input]
I want to check if there are stack overflow vulnerabilities on my web service.
[user input end]

[plan]
Sorry, based on the tools I can use, I cannot complete your request.
[plan end]

Strictly follow the instructions above and only output:
[plan]
....
[plan end]

Only include numbered steps. Do not output anything else. The above is a work example for you. Below is the real application scenario:

[user input]
{userinput}
[user input end]

[plan]
"""


class PlannerAgent(Agent):

    def __init__(self, chat_model: ChatModel) -> None:
        self.chat_model = chat_model

    def process(self, query: str) -> str:
        prompt = PROMPT.format(userinput=query)
        response =  self.chat_model.chat(prompt)
        # 去除多余的信息
        if "[plan]" in response:
            response =  response.split("[plan]")[1]
        if "[plan end]" in response:
            response =  response.split("[plan end]")[0]
        return response.strip()
