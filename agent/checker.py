from agent.base import Agent
from model.base import ChatModel

PLAN_PROMPT = """你是一个Web安全扫描助手，你懂得使用NMAP、W3AF、CMSeek、Dirsearch、Hydra、Sqlmap、tplmap以及XSStrike工具，同时你具有渗透测试的相关知识以及分析总结能力。
你的工作是判断一个步骤你是否可以通过上述的能力完成，步骤会以[user input]xxxxx[user input end]的形式给你，你需要用[result]xxx的格式给出你的判断，如果该步骤你无法全部完成或者步骤中包含手动过程，输出manu；如果该步骤你能通过使用上述渗透测试工具完成，输出auto；如果该步骤能通过你的分析总结能力完成，输出anal。
对你的第一要求是不要输出额外的内容，只输出manu、auto或anal四个字符，下面给你一个例子：
[user input]
使用Nmap判断127.0.0.1上是否存在sql注入漏洞
[user input end]
[result]
auto
如果需要人工完成，例子如下：
[user input]
确认Nmap扫描的目标ip和端口范围
[user input end]
[result]
manu
[user input]
审查XSStrike报告中提到的漏洞位置及详细信息
[user input end]
[result]
anal
注意严格根据上述指示进行输出，只输出manu、auto或anal，除了manu、auto或anal其余任何内容都不要输出。输出完之后立刻终止输出，不要再输出任何字符。以上为给你的工作范例，以下为真实应用场景:
[user input]
{userinput}
[user input end]

[result]
"""

PARAM_PROMPT = """你是一个任务状态分析助手，负责根据任务返回的状态码和任务信息，判断任务是否成功完成，并输出相关信息。如果任务失败，你需要解释失败原因，并给出可能的解决方案。请根据以下状态码和任务信息来提供判断：

状态码对应信息：
0: 任务成功执行。
-1: 创建函数时，参数错误。
-2: 创建函数时，函数名称错误。
-3: 创建函数时，格式错误。
-4: 创建函数完成失败。
-10: 执行函数调用失败。
-11: 执行函数时，翻译失败。
-12: 执行函数时，总结失败。
-20: 检查查询失败。
-21: 检查机器人状态失败。
-22: 域不存在错误。
-23: 检查能力失败。
注意，状态码为0只是表示任务成功执行，但是执行结果是否有效已经成功并不确定，如果你根据任务信息判断任务失败了或者结果无效，请你返回任务失败而不是任务成功。
输入格式：
状态码：整数，表示任务返回的状态。
任务信息：字符串，描述与任务相关的详细信息。
输出要求：
任务成功：如果状态码为0，输出“任务成功完成”。
任务失败：如果任务失败，依据状态码和任务信息，输出任务失败的具体原因和可能的解决方案。
示例：
输入：

状态码：-1
任务信息：函数创建时，参数格式不符合要求。
输出：

任务失败。原因：创建函数时参数错误。可能的解决方案：请检查输入的参数格式是否正确，并确保所有必要参数已提供。
下面是真实应用场景：
输入：

状态码：{code}
任务信息：{msg}
输出：
"""


class PlanCheckerAgent(Agent):

    def __init__(self, chat_model: ChatModel) -> None:
        self.chat_model = chat_model

    def process(self, query: str) -> str:
        prompt = PLAN_PROMPT.format(userinput=query)
        return self.chat_model.chat(prompt)


class ParamCheckerAgent(Agent):

    def __init__(self, chat_model: ChatModel) -> None:
        self.chat_model = chat_model

    def process(self, query: str) -> str:
        code, msg = query
        prompt = PARAM_PROMPT.format(code=code, msg=msg)
        return self.chat_model.chat(prompt)
