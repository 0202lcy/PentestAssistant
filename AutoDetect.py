from wenxinAgent import planner
from wenxinAgent import refiner
from wenxinAgent import checker
import requests
p = planner()
r = refiner()
c = checker()

def getInst(plan:str):
    insts = plan.split('\n')
    instNow = ''
    for inst in insts:
        if '[当前步骤]' in inst:
            instNow = inst
            break
    instNow.replace("当前步骤","")
    return instNow

target = input("请输入整体目标（输入'quit'退出）: ")
if target == "quit":
    exit()
plannow = p.query2bot(target)
headers = {
    'Content-Type': "application/json"
}
while True:
    inst = getInst(plannow)
    print(f"tempora instruction is {inst}")
    if c.query2bot(inst) == "auto":
        res = requests.post("http://localhost:8848/chat",json={"question":inst},headers=headers)
        code = res.status_code
        if code == 200:
            msg = res.json()["msg"]
            data = res.json()["data"]
            print(f"post return msg {msg},data {data}")
        else:
            print(f"error occurred, error code {code}")
    else:
        res = input("请输入目前步骤的结果（输入'quit'退出）: ")

    if res == 'quit':
        break
    else:
        plannow = r.query2bot(plannow, res).replace("[new plan","[plan")
