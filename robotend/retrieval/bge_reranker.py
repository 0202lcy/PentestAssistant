from typing import List

import torch
import numpy as np
from retrieval.base import Retrieval
from FlagEmbedding import FlagReranker


class BgeReranker(Retrieval):

    def __init__(self,
                 embedding_name_or_path: str,
                 use_fp16: bool = True) -> None:
        super().__init__(embedding_name_or_path)
        self.reranker = FlagReranker(embedding_name_or_path, use_fp16=use_fp16)

    def _get_top_k_values(self, lst: List[int], top_k: int) -> List[str]:
        arr = np.array(lst)
        top_k_indices = np.argsort(arr)[-top_k:]
        top_k_values = arr[top_k_indices]

        return top_k_values, top_k_indices

    @torch.no_grad()
    def compute_topk(self, query: str, answer_list: List[str],
                     top_k: int) -> List[str]:
        pairs = [[query, answer] for answer in answer_list]
        scores = self.reranker.compute_score(pairs)
        _, top_k_indices = self._get_top_k_values(scores, top_k)

        sorted_answer = []
        for index in range(0, min(top_k, len(pairs))):
            sorted_answer.append(answer_list[top_k_indices[index]])

        sorted_answer.reverse()
        return sorted_answer


if __name__ == "__main__":
    bge_ranker = BgeReranker(
        embedding_name_or_path=
        "/home/lwk/.cache/huggingface/hub/models--BAAI--bge-reranker-base")
    answer_list = [
        "Python is a high-level, general-purpose programming language. Its design philosophy emphasizes code readability with the use of significant indentation.",
        "Java is a high-level, class-based, object-oriented programming language that is designed to have as few implementation dependencies as possible.",
        "Go is a statically typed, compiled high-level programming language designed at Google[11] by Robert Griesemer, Rob Pike, and Ken Thompson",
    ]
    result = bge_ranker.compute_topk(query="What is Python?",
                                     answer_list=answer_list,
                                     top_k=2)
    print(result)
    """
    [
        'Python is a high-level, general-purpose programming language. Its design philosophy emphasizes code readability with the use of significant indentation.', 
        'Go is a statically typed, compiled high-level programming language designed at Google[11] by Robert Griesemer, Rob Pike, and Ken Thompson'
    ]
    """
